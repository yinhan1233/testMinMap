<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>第一屏数据筛选框</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href=
'/uploads/wechat/568869/file/第一屏筛选框/第一屏.css'
>
</head>

<body>
    <div id="box">
        <nav id="selectnav" style="z-index: 999;">
            <div id="button-img" onclick="showclose()"><img src=
'/uploads/wechat/568869/file/第一屏筛选框/buttonimg.png'
></div>

            <!-- 菜单内容 -->
            <div id="dataSelect">
                <form method="get" action="" class="itembox" id="timeSelect" onchange="getTimeFunction()">
                    <span class="title">时间范围</span>
                    <label><input class="circle" type="radio" name="time" value="1">今天</label>
                    <label><input class="circle" type="radio" name="time" value="7">7天</label>
                    <label><input class="circle" type="radio" name="time" value="30">1个月</label>
                    <label><input class="circle" type="radio" name="time" value="-1">自定义
                        <label><input type="date" name="time" value="starttime" placeholder="开始时间" id="starttime"
                                style="width: 110px;"></label>
                        <label><input type="date" name="time" value="endtime" id="endtime"
                                style="width: 110px;"></label>
                    </label>
                </form>

                <form method="get" action="" class="itembox" id="tendSelect" onchange="getTendFunction()">
                    <span class="title">倾向性</span>
                    <label><input class="circle" type="radio" name="tend" value="all">全部</label>
                    <label><input class="circle" type="radio" name="tend" value="pos">正面</label>
                    <label><input class="circle" type="radio" name="tend" value="netural">中性</label>
                    <label><input class="circle" type="radio" name="tend" value="neg">负面</label>
                </form>

                <form method="get" action="" class="itembox" id="numberSelect" onchange="getNumFunction()">
                    <span class="title">数据正负向</span>
                    <span class="numberchoice"><label><input class="circle" type="radio" name="number" value="num1">1000
                            < 5000</label></span>
                    <span class="numberchoice"><label><input class="circle" type="radio" name="number" value="num2">5000
                            < 10000</label></span>
                    <span class="numberchoice"><label><input class="circle" type="radio" name="number" value="自定义">
                            <input class="inputnum" type="text" placeholder="开始值" id="startnum">
                            < <input class="inputnum" type="text" placeholder="结束值" id="endnum">
                        </label>
                    </span>
                </form>

                <div class="itembox">
                    <span class="title">全部主题(<label id="selected"></label>)</span>
                    <input type="text" id="searchtxt" placeholder="搜索关键字" onchange="themeSearch()"
                        style="width: 100%;margin-top: 0.5%;margin-bottom: 5px;">
                    <form method="get" action="" id="themeSelect" onchange="getThemeFunction()">
                        <div id="bottom">
                        </div>
                    </form>
                </div>
            </div>
        </nav>
    </div>

    <script type="text/javascript">
        // 此时不添加下列函数也可以实现回车搜索，说明回车搜索不能在form表单中使用
        // $("searchtxt").keydown(function (e) {//当按下按键时
        //     if (e.keyCode == 13) {//.which属性判断按下的是哪个键，回车键的键位序号为13
        //         $("searchtxt").trigger("click");//触发搜索按钮的点击事件
        //     }
        // });

        //按钮点击事件
        var show = false;
        var menubox = document.getElementById('selectnav');
        function showclose() {
            window.parent.changeZIndexById(menubox.style.zIndex);
            console.log(menubox.style.zIndex)
            if (show) {
                menubox.style.height = '53px';
                menubox.style.width = '76px';
                menubox.style.backgroundColor = 'transparent';
                menubox.style.zIndex = 999;
                show = false;
            } else {
                menubox.style.height = '766px';
                menubox.style.width = '566px';
                menubox.style.backgroundColor = '#050505';
                menubox.style.zIndex = 1;
                show = true;
            }
        }
        // //点击其他空白地方按钮收起
        // window.onclick = function (e) {
        //     // e.path是由点击对象所经过的所有dom层级冒泡组成的一个数组，比如当我们点击suggest，实际上也点了box和html
        //     // 这里利用some的方法判断这个数组内部的元素是否经过box（注意e.path的数组元素是node节点），是否是search的一环
        //     // some函数返回一个布尔值，如果是false，则点击的地方与box无关，那样的话，就将suggest关闭
        //     let flag = e.path.some(item => item == menubox)
        //     if (!flag) {
        //         menubox.style.height = '53px';
        //         menubox.style.width = '76px';
        //         menubox.style.backgroundColor = 'transparent';
        //     }
        // }

        window.onload = function () {
            initsign();//登录
        }

        var timechoice = document.getElementById("timeSelect");
        var tendschoice = document.getElementById("tendSelect");
        var numberchoice = document.getElementById("numberSelect");
        var themenum = document.getElementById("themeSelect");

        function initsign() {
            //第一步登录函数
            $.ajax({
                type: "post",
                url: "https://dt-api.xunku.org/login/login?action=portal.AppLogin&userName=cmtea&password=cmtea398&vcode=&vcodeCorrect=&platformCode=41e1fbcd4355ac6731376a8340a2cb0f&columnName=Name",
                async: false, //是否异步
                crossDomain: true,
                xhrFields: { withCredentials: true },
                dataType: "json",
                success: function (result1) {
                    var statusCode = result1.statusCode; //返回是否成功登陆的状态
                    data_token = result1.token; //登陆成功时返回token
                    window.sessionStorage.setItem("data_token", data_token); //将data_token保存在浏览器的session中
                    // console.log(statusCode);
                    // console.log(data_token); //打印状态和获取的token
                    if (statusCode === "SUCESS") {
                        console.log("正在尝试获取主题...")
                        var jsonTokenData = {
                            token: window.sessionStorage.getItem("data_token"),
                            keyword: "",
                        };
                        $.ajax({
                            //二、获取主题列表层
                            type: "post",
                            url: "https://dt-api.xunku.org/mediaUniversity/subjectMonitor/getUserSubject",
                            data: JSON.stringify(jsonTokenData),
                            crossDomain: true,
                            xhrFields: { withCredentials: true },
                            contentType: "application/json;charset=utf-8",
                            processData: false,
                            dataType: "json",
                            success: function (resultList) {
                                console.log("获得主题成功");
                                console.log(resultList)
                                console.log(JSON.stringify(resultList.data));
                                var themebox = document.getElementById("bottom");
                                var totalLableData = resultList.data;
                                for (var themename in totalLableData) {
                                    var newtheme = document.createElement("label");
                                    newtheme.className = "themes";
                                    newtheme.innerHTML =
                                        "<input type='checkbox' name='theme' value='" + themename + "'>" + totalLableData[themename];
                                    themebox.appendChild(newtheme);
                                }
                                var themenum = document.getElementById("themeSelect");
                                document.getElementById("selected").innerHTML = themenum.length;
                            },
                        });
                    } else {
                        console.log("登陆失败");
                        console.log(result1.data);
                    }
                },
            });

        }


        function getTimeFunction() {
            starttime = document.getElementById("starttime").value
            endtime = document.getElementById("endtime").value
            for (var i = 0; i < timechoice.length; i++) {
                if (timechoice[i].checked) {
                    timevalue = timechoice[i].value.toString();
                    if (timevalue == "1" || timevalue == "7" || timevalue == "30") {
                        var jsonTimeData = {
                            token: window.sessionStorage.getItem("data_token"),
                            dateType: timevalue
                        }
                        $.ajax({
                            //设置已选时间
                            type: "post",
                            // url: "https://dt-test.xunku.org/core.action?action=subjectMonitor.SubjectMonitor.settingOther&settingOther={\"dateType\":" + timevalue + "}",
                            url: "https://dt-api.xunku.org/mediaUniversity/subjectMonitor/settingOther",
                            data: JSON.stringify(jsonTimeData),
                            crossDomain: true,
                            xhrFields: { withCredentials: true },
                            contentType: "application/json;charset=utf-8",
                            processData: false,
                            dataType: "json",
                            success: function (result5) {
                                // console.log(timevalue)
                                // console.log("已经获得时间")
                                // console.log(result5)
                                if (result5.data >= 0) {
                                    // console.log("已经获得时间")
                                    window.parent.updateData();

                                    // getTimeSetting()
                                } else {
                                    console.log("没有获取到数据")
                                }
                            }
                        });
                    }
                    // if (timevalue == "-1") {
                    //     if (starttime != " " && endtime != " ") {
                    //         console.log(starttime + " 至 " + endtime)
                    //         var jsonTimeData = {
                    //             token: window.sessionStorage.getItem("data_token"),
                    //             dateType: timevalue,
                    //             startTime: starttime,
                    //             "endTime": endtime,
                    //         }
                    //         $.ajax({
                    //             //设置已选时间
                    //             type: "post",
                    //             url: "https://dt-api-test.xunku.org/mediaUniversity/subjectMonitor/settingOther",
                    //             data: JSON.stringify(jsonTimeData),
                    //             crossDomain: true,
                    //             xhrFields: { withCredentials: true },
                    //             contentType: "application/json;charset=utf-8",
                    //             processData: false,
                    //             dataType: "json",
                    //             success: function (result6) {
                    //                 window.parent.updateData();

                    //                 // console.log(timevalue)
                    //                 // console.log("已经获得时间")
                    //                 // console.log(result6)
                    //                 // if (result6.data >= 0) {
                    //                 //     // console.log("已经获得时间")
                    //                 //     // getTimeSetting()
                    //                 // } else {
                    //                 //     console.log("没有获取到数据")
                    //                 // }
                    //             }
                    //         });
                    //     }
                    // }
                }
            }
        }
        // function getTimeSetting() {
        //     $.ajax({
        //         //获取已选时间
        //         type: "post",
        //         url: $.ajax({
        //             type: "post",
        //             url: "https://dt-test.xunku.org/core.action?action=subjectMonitor.SubjectMonitor.getUserSettingOther",
        //             crossDomain: true,
        //             headers: {
        //                 "x-auth-token": data_token,
        //             }, //头部携带刚才登录获取的token
        //             xhrFields: { withCredentials: true },
        //             dataType: "json",
        //             success: function (result7) {
        //                 console.log("获得已设置时间")
        //                 console.log(result7.data)
        //             }
        //         })
        //     })
        // }
        function getTendFunction() {
            for (var i = 0; i < tendschoice.length; i++) {
                if (tendschoice[i].checked) {
                    alert(tendschoice[i].value);
                    value = tendschoice[i].value;
                }
            }
        }

        function getNumFunction() {
            for (var i = 0; i < numberchoice.length; i++) {
                if (numberchoice[i].checked) {
                    numbervalue = numberchoice[i].value;
                    if (numbervalue == "num1" || numbervalue == "num2") {
                        alert(numbervalue);
                    } else if (document.getElementById("startnum").value != " " && document.getElementById("endnum").value != " ") {
                        alert("开始值" + document.getElementById("startnum").value + " < " + "结束值" + document.getElementById("endnum").value)
                    }
                }
            }
        }

        // 对选中标签总数进行限制
        function getThemeFunction() {
            var themeselect = [];
            var count = 0;
            for (var i = 0; i < themenum.length; i++) {
                if (themenum[i].checked) {
                    if (count == 3) {
                        alert('最多选中三个主题');
                        themenum[i].checked = false;
                        break;
                    }
                    themeselect.push(themenum[i].value)//这种放置为数组
                    // themeselect += [themenum[i].value] + " " ;//这样就为单个字符
                    count++;
                }
            }
            console.log(themeselect)
            var themelist = []
            for (var i = 0; i < themeselect.length; i++) {
                var theme = {};
                theme["subjectId"] = themeselect[i];
                themelist.push(theme);
            }
            console.log(themelist);
            document.getElementById("selected").innerHTML = count + "/" + themenum.length;
            var jsonData = {
                token: window.sessionStorage.getItem("data_token"),
                settingSubject: themelist,
            };
            console.log(jsonData);
            $.ajax({
                //三、设置主题层
                type: "post",
                url: "https://dt-api.xunku.org/mediaUniversity/subjectMonitor/settingSubject",
                data: JSON.stringify(jsonData),
                crossDomain: true,
                xhrFields: { withCredentials: true },
                contentType: "application/json;charset=utf-8",
                processData: false,
                dataType: "json",
                success: function (resultSetting) {
                    window.parent.updateData();

                    // console.log("设置主题成功");
                    // console.log(resultSetting);
                    // if (resultSetting.statusCode === "SUCESS") {
                    //     console.log("正在获取数据...");
                    //     getThemedata()
                    // }
                },
            });

        }

        // function getThemedata() {
        //     var jsonGetData = {
        //         token: window.sessionStorage.getItem("data_token"),
        //     };
        //     $.ajax({
        //         //四、获取数据
        //         type: "post",
        //         url: "https://dt-api-test.xunku.org/mediaUniversity/subjectMonitor/region",
        //         data: JSON.stringify(jsonGetData),
        //         contentType: "application/json;charset=utf-8",
        //         crossDomain: true,
        //         // headers: {
        //         //   "x-auth-token": window.sessionStorage.getItem("data_token"),
        //         // }, //头部携带刚才登录获取的token
        //         xhrFields: { withCredentials: true },
        //         dataType: "json",
        //         success: function (resultData) {
        //             console.log(resultData);
        //             if (resultData.length >= 0) {
        //                 console.log("获得数据成功");
        //             } else {
        //                 console.log("获得数据失败");
        //             }
        //         },
        //     });
        // }
        //进行即时搜索
        function themeSearch() {
            const that = this;
            var themebox = document.getElementById("bottom");
            //得到输入框输入的值
            var filterContent = document.getElementById("searchtxt").value;
            // 每次搜索，先检查搜索框内容是否为空
            // 若空，则从标签库中读取全部标签展示
            if (filterContent === '') {
                themebox.innerHTML = '';
                initLables();
            } else { // 若不空，在标签库中进行遍历搜索
                var reg = new RegExp(filterContent);
                var matchedThemes = {};
                // console.log('length' + Object.keys(that.totalLableData).length);
                //正则匹配
                for (themeSearching in that.totalLableData) {
                    if (totalLableData[themeSearching].match(reg)) {
                        matchedThemes[themeSearching] = totalLableData[themeSearching];
                        // console.log(themeSearching + ':' + matchedThemes[themeSearching]);
                    }
                }
                themebox.innerHTML = '';//作用可能是将页面置空？
                for (theme in matchedThemes) {
                    var newtheme = document.createElement('label');
                    newtheme.className = "themes";
                    newtheme.innerHTML = '<input type="checkbox" name="theme" value="' + matchedThemes[theme] + '">' + matchedThemes[theme];
                    themebox.appendChild(newtheme);
                }
            }
        }
    </script>
</body>

</html>